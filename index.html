<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AnimeTracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#0B0F18; --surface:#121722; --muted:#94a3b8; --ink:#e2e8f0; --pri:#38bdf8; }
    html,body { height:100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--ink); }
    /* Fix: some buttons not clickable due to overlay → unify stacking contexts */
    header, main, #modal-root { position: relative; z-index: 0; }
    #modal-root { z-index: 50; }
    .btn { @apply inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 text-sm font-semibold transition; }
    .btn-ghost { @apply hover:bg-slate-700/60; }
    .btn-pri { background:var(--pri); color:#001018; }
    .btn-pri:hover { filter:brightness(1.1); }
    .card { @apply rounded-2xl bg-slate-800/70 border border-slate-700/60 shadow-xl; }
    .skeleton { background: linear-gradient(90deg, #1f2937 25%, #374151 37%, #1f2937 63%); background-size: 400% 100%; animation: shimmer 1.2s ease-in-out infinite; }
    @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:-100% 0} }
    .scrollbar::-webkit-scrollbar { width: 10px; height:10px }
    .scrollbar::-webkit-scrollbar-thumb { background:#334155; border-radius:8px }
    .scrollbar::-webkit-scrollbar-track { background:#0f172a }
    .clickable { cursor:pointer }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-40 w-full border-b border-slate-800 bg-slate-900/80 backdrop-blur">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 rounded-xl bg-sky-400/20 grid place-items-center"><span class="text-sky-400 font-extrabold">A</span></div>
          <h1 class="text-xl sm:text-2xl font-extrabold"><span class="text-sky-400">Anime</span>Tracker</h1>
        </div>
        <div class="flex items-center gap-2">
          <div class="relative">
            <input id="searchInput" autocomplete="off" class="w-56 sm:w-72 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 pr-10 text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Search anime (AniList)…" />
            <button id="searchBtn" class="absolute right-1 top-1 btn btn-ghost" title="Search">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.2-5.2m1.7-4.5a7.5 7.5 0 11-15 0 7.5 7.5 0 0115 0z"/></svg>
            </button>
            <div id="searchResults" class="absolute mt-2 w-[min(90vw,28rem)] max-h-96 overflow-auto scrollbar hidden card p-1"></div>
          </div>
          <button id="manageBtn" class="btn btn-ghost" title="Manage Lists">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6"/></svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="w-full border-b border-slate-800">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div id="tabs" class="flex gap-2 overflow-x-auto py-2 scrollbar"></div>
      </div>
    </div>

    <!-- Main -->
    <main class="mx-auto max-w-7xl flex-1 w-full px-4 sm:px-6 lg:px-8 py-6">
      <div id="state" class="py-8 text-center text-slate-400"></div>
      <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
    </main>
  </div>

  <!-- Modal root & Toast -->
  <div id="modal-root"></div>
  <div id="toast" class="fixed bottom-4 right-4 hidden px-4 py-2 rounded-xl bg-emerald-600 text-white shadow-lg"></div>

  <script type="module">
    // ========= CONFIG (embedded; no settings screen) =========
    // IMPORTANT: Replace with YOUR deployed Apps Script Web App URL (must end with /exec)
    const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbzJKB-viAwLEtUcS_mQQUi4wr0QzWc181kVC826fCQiwzYYV3DyI-77jRoWqo4yQtth/exec';
    const ANILIST_API_URL = 'https://graphql.anilist.co';

    if (!GOOGLE_SHEET_URL || GOOGLE_SHEET_URL.includes('PASTE_')) {
      alert('Configure GOOGLE_SHEET_URL inside the HTML first.');
    }

    // ========= STATE (no localStorage caching per client request) =========
    const state = {
      lists: [],
      anime: [], // array of { anilistId, idMal, title, coverImage, status, score, description, format, episodes, dateAdded }
      active: '',
      cache: new Map(), // in-memory only per session to speed UI, not persisted
      loading: true,
    };

    // ========= DOM =========
    const els = {
      tabs: document.getElementById('tabs'),
      grid: document.getElementById('grid'),
      state: document.getElementById('state'),
      searchInput: document.getElementById('searchInput'),
      searchBtn: document.getElementById('searchBtn'),
      searchResults: document.getElementById('searchResults'),
      manageBtn: document.getElementById('manageBtn'),
      modalRoot: document.getElementById('modal-root'),
      toast: document.getElementById('toast'),
    };

    // ========= Utilities =========
    const qs = o => Object.entries(o).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(typeof v==='string'?v:JSON.stringify(v))}`).join('&');
    const toast = (msg, ok=true) => {
      els.toast.textContent = msg; els.toast.classList.remove('hidden'); els.toast.style.background = ok? '#059669' : '#dc2626';
      setTimeout(()=> els.toast.classList.add('hidden'), 2500);
    };

    function cardSkeleton(n=12){
      return Array.from({length:n}).map(()=>`
        <div class="card overflow-hidden">
          <div class="aspect-[2/3] skeleton"></div>
          <div class="p-3 space-y-2">
            <div class="h-4 w-3/4 skeleton rounded"></div>
            <div class="h-3 w-1/2 skeleton rounded"></div>
          </div>
        </div>`).join('');
    }

    // ========= Backend I/O (GET tunnel for all mutations to avoid preflight) =========
    async function apiSnapshot(){
      const res = await fetch(GOOGLE_SHEET_URL, { method:'GET', mode:'cors' });
      if (!res.ok) throw new Error('Snapshot failed');
      return res.json();
    }
    async function apiAddOrUpdate(anime){
      const url = `${GOOGLE_SHEET_URL}?${qs({ action:'addOrUpdateAnime', data: anime })}`;
      const res = await fetch(url, { method:'GET', mode:'cors', cache:'no-store' });
      if (!res.ok) throw new Error('Update failed');
      return res.json();
    }
    async function apiDelete(anilistId){
      const url = `${GOOGLE_SHEET_URL}?${qs({ action:'deleteAnime', anilistId })}`;
      const res = await fetch(url, { method:'GET', mode:'cors', cache:'no-store' });
      if (!res.ok) throw new Error('Delete failed');
      return res.json();
    }
    async function apiManageLists(lists){
      const url = `${GOOGLE_SHEET_URL}?${qs({ action:'manageLists', lists })}`;
      const res = await fetch(url, { method:'GET', mode:'cors', cache:'no-store' });
      if (!res.ok) throw new Error('Lists update failed');
      return res.json();
    }

    // ========= AniList search =========
    async function searchAniList(term){
      const query = `query ($search: String, $page: Int, $perPage: Int) { Page (page: 1, perPage: 10) { media (search: $search, type: ANIME, sort: SEARCH_MATCH) { id idMal title { romaji english native } coverImage { extraLarge color } description(asHtml:false) averageScore format episodes seasonYear } } }`;
      const res = await fetch(ANILIST_API_URL, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ query, variables:{ search: term }}) });
      if (!res.ok) throw new Error('AniList search failed');
      const data = await res.json();
      return data?.data?.Page?.media || [];
    }

    // ========= Renderers =========
    function renderTabs(){
      els.tabs.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.lists.forEach(list => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn ${state.active===list ? 'bg-slate-700' : 'btn-ghost'} shrink-0`;
        btn.textContent = list;
        btn.addEventListener('click', () => { state.active = list; renderGrid(); renderTabs(); });
        frag.appendChild(btn);
      });
      els.tabs.appendChild(frag);
    }

    function renderGrid(){
      const items = state.anime.filter(a => a.status === state.active);
      if (!state.active) { els.state.innerHTML = '<p class="text-slate-400">Create a list to get started.</p>'; els.grid.innerHTML=''; return; }
      if (state.loading) { els.state.innerHTML=''; els.grid.innerHTML = cardSkeleton(); return; }
      if (items.length === 0) { els.state.innerHTML = `<p class="text-slate-400">No items in <span class="text-sky-400 font-semibold">${state.active}</span>. Search and add some!</p>`; els.grid.innerHTML=''; return; }
      els.state.innerHTML='';
      els.grid.innerHTML = items.map(cardHTML).join('');
      // Bind click handlers after inject
      items.forEach(it => {
        const btn = document.getElementById(`open-${it.anilistId}`);
        if (btn) btn.addEventListener('click', () => openModal(it.anilistId));
      });
    }

    function cardHTML(a){
      const title = a.title;
      const score = a.score ? (a.score/10).toFixed(1) : '—';
      return `
      <div class="card overflow-hidden group">
        <div class="relative">
          <img src="${a.coverImage}" alt="${title}" class="w-full h-full aspect-[2/3] object-cover" loading="lazy" />
          <div class="absolute top-2 right-2 rounded-full bg-black/70 px-2.5 py-1 text-xs font-bold">⭐ ${score}</div>
        </div>
        <div class="p-3 flex items-center justify-between gap-2">
          <div class="truncate font-semibold text-sm group-hover:text-sky-400">${title}</div>
          <button id="open-${a.anilistId}" class="btn btn-ghost" title="Open">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </button>
        </div>
      </div>`;
    }

    function openModal(id){
      const a = state.anime.find(x => x.anilistId == id);
      if (!a) return;
      const lists = state.lists.map(l => `<button data-l="${l}" class="btn ${a.status===l?'bg-sky-600 text-white':'btn-ghost'}">${l}</button>`).join('');
      els.modalRoot.innerHTML = `
      <div class="fixed inset-0 z-50 grid place-items-center p-4">
        <div class="absolute inset-0 bg-black/70" data-close></div>
        <div class="card relative max-w-3xl w-full overflow-hidden">
          <button class="absolute right-3 top-3 btn btn-ghost" data-close aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <img src="${a.coverImage}" alt="${a.title}" class="w-full aspect-[2/3] object-cover md:rounded-l-2xl" />
            <div class="md:col-span-2 p-4 space-y-3">
              <h2 class="text-2xl font-extrabold">${a.title}</h2>
              <div class="text-xs text-slate-400">Added: ${new Date(a.dateAdded||Date.now()).toLocaleString()}</div>
              <p class="text-sm text-slate-300 max-h-40 overflow-auto scrollbar">${(a.description||'No description').slice(0,600)}${a.description && a.description.length>600?'…':''}</p>
              <div class="flex flex-wrap gap-2">${lists}</div>
              <div class="pt-2 flex justify-between">
                <div class="text-sm text-slate-400">Format: ${a.format||'—'} · Episodes: ${a.episodes??'—'}</div>
                <button id="del-${a.anilistId}" class="btn btn-ghost text-red-400 hover:text-red-200">Delete</button>
              </div>
            </div>
          </div>
        </div>
      </div>`;
      // Close handlers
      els.modalRoot.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', ()=> els.modalRoot.innerHTML=''));
      // Status change
      els.modalRoot.querySelectorAll('button[data-l]').forEach(b => b.addEventListener('click', async () => {
        const newStatus = b.getAttribute('data-l');
        const updated = { ...a, status: newStatus };
        try { await apiAddOrUpdate(updated); toast(`Moved to ${newStatus}`); } catch(e){ toast('Update failed', false); return; }
        const idx = state.anime.findIndex(x=>x.anilistId==a.anilistId); state.anime[idx] = updated; renderGrid(); openModal(a.anilistId);
      }));
      // Delete
      const del = document.getElementById(`del-${a.anilistId}`);
      del.addEventListener('click', async () => {
        if (!confirm('Delete this anime?')) return;
        try { await apiDelete(a.anilistId); toast('Deleted'); } catch(e){ toast('Delete failed', false); return; }
        state.anime = state.anime.filter(x=>x.anilistId!=a.anilistId); els.modalRoot.innerHTML=''; renderGrid();
      });
    }

    function renderSearch(results){
      if (!results || !results.length){ els.searchResults.innerHTML = '<div class="p-3 text-sm text-slate-400">No results</div>'; els.searchResults.classList.remove('hidden'); return; }
      els.searchResults.innerHTML = results.map(r => {
        const t = r.title.english || r.title.romaji || r.title.native;
        const img = r.coverImage.extraLarge;
        return `<div class="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-700/60 clickable" data-id="${r.id}">
          <img src="${img}" class="w-10 h-14 object-cover rounded" alt="${t}"/>
          <div class="min-w-0"><div class="truncate font-semibold">${t}</div><div class="text-xs text-slate-400">${r.format||''} ${r.seasonYear?('· '+r.seasonYear):''}</div></div>
        </div>`;
      }).join('');
      els.searchResults.classList.remove('hidden');
      // Bind
      els.searchResults.querySelectorAll('[data-id]').forEach(item => item.addEventListener('click', async () => {
        const id = item.getAttribute('data-id');
        const r = results.find(x=>x.id==id);
        if (!r) return;
        const anime = {
          anilistId: r.id,
          idMal: r.idMal ?? '',
          title: r.title.english || r.title.romaji || r.title.native,
          coverImage: r.coverImage.extraLarge,
          status: state.active || state.lists[0] || 'Watching',
          score: r.averageScore ?? '',
          description: r.description ?? '',
          format: r.format ?? '',
          episodes: r.episodes ?? '',
          dateAdded: new Date().toISOString(),
        };
        try { await apiAddOrUpdate(anime); toast(`Added to ${anime.status}`); } catch(e){ toast('Add failed', false); return; }
        const idx = state.anime.findIndex(x=>x.anilistId==anime.anilistId);
        if (idx>=0) state.anime[idx] = { ...state.anime[idx], ...anime }; else state.anime.push(anime);
        els.searchResults.classList.add('hidden'); els.searchInput.value=''; renderGrid();
      }));
    }

    // ========= Manage Lists Modal =========
    function openManage(){
      const listItems = state.lists.map(l => `<div class="flex items-center gap-2"><input value="${l}" class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700"/><button class="btn btn-ghost text-red-400" data-del>Remove</button></div>`).join('');
      els.modalRoot.innerHTML = `
      <div class="fixed inset-0 z-50 grid place-items-center p-4">
        <div class="absolute inset-0 bg-black/70" data-close></div>
        <div class="card max-w-lg w-full p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">Manage Lists</h3>
            <button class="btn btn-ghost" data-close aria-label="Close">✕</button>
          </div>
          <div id="editor" class="space-y-2 max-h-72 overflow-auto scrollbar">${listItems}</div>
          <div class="flex items-center gap-2 pt-4">
            <button id="addList" class="btn btn-ghost">Add</button>
            <div class="flex-1"></div>
            <button id="saveLists" class="btn btn-pri">Save</button>
          </div>
        </div>
      </div>`;
      els.modalRoot.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', ()=> els.modalRoot.innerHTML=''));
      const editor = document.getElementById('editor');
      document.getElementById('addList').addEventListener('click', ()=>{
        const wrap = document.createElement('div');
        wrap.className = 'flex items-center gap-2';
        wrap.innerHTML = `<input placeholder="New list" class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700"/><button class="btn btn-ghost text-red-400" data-del>Remove</button>`;
        editor.appendChild(wrap);
      });
      editor.addEventListener('click', e=>{
        const btn = e.target.closest('[data-del]');
        if (btn) btn.parentElement.remove();
      });
      document.getElementById('saveLists').addEventListener('click', async ()=>{
        const names = Array.from(editor.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
        if (!names.length){ toast('At least one list is required', false); return; }
        try { await apiManageLists(names); toast('Lists saved'); } catch(e){ toast('Save failed', false); return; }
        state.lists = names;
        if (!state.lists.includes(state.active)) state.active = state.lists[0];
        els.modalRoot.innerHTML=''; renderTabs(); renderGrid();
      });
    }

    // ========= Init =========
    async function init(){
      // Wire buttons (ensure clickable and on top)
      els.manageBtn.addEventListener('click', openManage);
      els.searchBtn.addEventListener('click', async ()=>{
        const val = els.searchInput.value.trim(); if (val.length<3){ renderSearch([]); return; }
        try { const results = await searchAniList(val); renderSearch(results); } catch(e){ renderSearch([]); }
      });
      els.searchInput.addEventListener('keydown', async (e)=>{
        if (e.key==='Enter') { els.searchBtn.click(); }
      });
      document.addEventListener('click', (e)=>{
        if (!e.target.closest('#searchResults') && !e.target.closest('#searchInput') && !e.target.closest('#searchBtn')) {
          els.searchResults.classList.add('hidden');
        }
      });

      // Initial snapshot
      els.grid.innerHTML = cardSkeleton();
      try {
        const snap = await apiSnapshot();
        state.lists = Array.isArray(snap.lists) && snap.lists.length ? snap.lists : ['Watching','Completed','On Hold'];
        state.anime = Array.isArray(snap.anime) ? snap.anime : [];
        state.active = state.lists[0] || '';
        state.loading = false;
      } catch (e){
        state.loading = false; toast('Failed to load database', false);
        // Still provide defaults so UI is usable
        if (!state.lists.length) state.lists = ['Watching','Completed'];
        state.active = state.lists[0];
      }
      renderTabs();
      renderGrid();
    }

    init();
  </script>
</body>
</html>
