<!DOCTYPE html>
<html lang="en" class="bg-gray-950 text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="AniList Tracker with MAL/Kitsu Scores, Custom Lists & Google Sheets Sync">
  <title>AniTracker Pro</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'anilist-pink': '#ff69a5',
            'mal-orange': '#f5a442',
            'kitsu-purple': '#7356a4',
            'status-green': '#5cd485',
            'status-blue': '#42a5f5',
            'status-yellow': '#fbc02d',
            'status-red': '#e57373',
            'status-gray': '#9e9e9e',
            'glass-bg': 'rgba(30, 30, 40, 0.4)',
          },
          backdropBlur: {
            xs: '2px',
          },
          keyframes: {
            'fade-in': { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
            'slide-up': { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
            'scale-in': { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } }
          },
          animation: {
            'fade-in': 'fade-in 0.4s ease-out',
            'slide-up': 'slide-up 0.5s ease-out',
            'scale-in': 'scale-in 0.3s ease-out'
          }
        }
      }
    }
  </script>

  <!-- Alpine.js for reactivity -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Preconnect to APIs for faster search -->
  <link rel="preconnect" href="https://graphql.anilist.co" />
  <link rel="preconnect" href="https://api.jikan.moe" />
  <link rel="preconnect" href="https://kitsu.io" />

  <style>
    body { font-family: 'Inter', sans-serif; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-hover:hover { transform: translateY(-4px); }
    .score-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: linear-gradient(45deg, #000, #222);
      color: white;
      font-weight: bold;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .search-container {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    .search-container.active {
      opacity: 1;
      transform: translateY(0);
    }
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s steps(3, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-950 to-black" x-data="app">

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-black/70 backdrop-blur-md border-b border-gray-800">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <svg class="w-7 h-7 text-anilist-pink" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        <h1 class="text-xl font-bold bg-gradient-to-r from-anilist-pink to-mal-orange bg-clip-text text-transparent">
          AniTracker Pro
        </h1>
      </div>

      <div class="flex items-center space-x-3">
        <!-- Search Toggle -->
        <button @click="toggleSearch" class="p-2 hover:bg-gray-800 rounded-full transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>

        <!-- Dark Mode -->
        <button @click="darkMode = !darkMode" class="p-2 hover:bg-gray-800 rounded-full transition">
          <span x-show="darkMode">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm0 14a6 6 0 110-12 6 6 0 010 12z"></path><path d="M10 4v2m0 8v2M4.22 4.22l1.42 1.42m9.16 9.16l1.42 1.42M4.22 15.78l1.42-1.42M14.36 5.64l1.42-1.42"></path></svg>
          </span>
          <span x-show="!darkMode" style="display:none">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
          </span>
        </button>
      </div>
    </div>

    <!-- Full-Width Search Bar -->
    <div class="px-4 pb-3" x-show="searchOpen" x-transition>
      <div class="search-container" :class="{ 'active': searchOpen }">
        <input
          type="text"
          x-model="searchQuery"
          @input.debounce.500ms="fetchSearchResults"
          placeholder="Search anime or manga..."
          class="w-full bg-gray-800 text-white rounded-xl pl-12 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-anilist-pink"
          @blur="searchOpen = false"
        />
        <svg class="w-5 h-5 text-gray-400 absolute left-6 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <div x-show="loading" class="absolute right-4 top-3.5">
          <div class="w-5 h-5 border-2 border-anilist-pink border-t-transparent rounded-full animate-spin"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative h-64 bg-gradient-to-r from-purple-900/40 to-pink-900/20 flex items-center px-4">
    <div class="container mx-auto">
      <h2 class="text-3xl md:text-4xl font-bold mb-2 animate-slide-up">Your Anime Universe</h2>
      <p class="text-lg opacity-90 max-w-lg animate-slide-up" style="animation-delay: 0.2s">Track, compare, and manage your anime with multi-source scores and custom lists.</p>
    </div>
  </section>

  <!-- Custom Lists Tabs -->
  <section class="py-4 px-4 border-b border-gray-800">
    <div class="container mx-auto">
      <div class="flex space-x-1 overflow-x-auto">
        <template x-for="list in customLists" :key="list.id">
          <button
            @click="activeList = list.id"
            class="px-4 py-2 rounded-lg whitespace-nowrap transition"
            :class="activeList === list.id ? 'bg-anilist-pink text-white' : 'hover:bg-gray-800 text-gray-300'"
          >
            <span x-text="list.name"></span>
            <span class="ml-1 text-sm opacity-70" x-text="`(${list.items.length})`"></span>
          </button>
        </template>
        <button @click="openCreateListModal" class="px-3 py-2 text-anilist-pink hover:bg-gray-800 rounded-lg">
          + New List
        </button>
      </div>
    </div>
  </section>

  <!-- Anime Grid -->
  <main class="py-6 px-4">
    <div class="container mx-auto">
      <!-- No Results -->
      <div x-show="searchOpen && results.length === 0 && !loading && searchQuery.length >= 2" class="text-center py-8 text-gray-400">
        No results found for "<span x-text="searchQuery"></span>"
      </div>

      <!-- Results -->
      <div x-show="searchOpen && results.length > 0" class="mb-6">
        <h3 class="text-lg font-semibold mb-3">Search Results</h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
          <template x-for="item in results" :key="item.id">
            <div
              class="relative rounded-lg overflow-hidden bg-gray-900 card-hover shadow-lg transform transition cursor-pointer group"
              @click="openMediaModal(item)"
            >
              <div class="score-badge" x-text="formatScore(item.averageScore)"></div>
              <img :src="item.coverImage?.extraLarge || item.coverImage?.large" alt="" class="w-full h-44 object-cover">
              <div class="p-2">
                <h4 class="font-medium text-sm line-clamp-2" x-text="item.title.english || item.title.romaji"></h4>
                <span class="text-xs text-gray-400" x-text="item.format"></span>
              </div>
              <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                <span class="text-sm font-medium">View Details</span>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- My List -->
      <div x-show="!searchOpen || results.length === 0">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
          <template x-for="item in displayedItems" :key="item.MediaId">
            <div
              class="relative rounded-lg overflow-hidden bg-gray-900 card-hover shadow-lg transform transition cursor-pointer group"
              @click="openMediaModal(item)"
            >
              <div class="score-badge" x-text="formatScore(item.Score)"></div>
              <img :src="item.CoverImage" alt="" class="w-full h-44 object-cover">
              <div class="p-2">
                <h4 class="font-medium text-sm line-clamp-2" x-text="item.Title"></h4>
                <span class="text-xs text-gray-400" x-text="item.Format"></span>
              </div>
              <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                <span class="text-sm font-medium">View Details</span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </main>

  <!-- Media Detail Modal -->
  <div x-show="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0,0,0,0.8);">
    <div x-show="showModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100" @click.outside="showModal = false" class="bg-gray-900 rounded-xl max-w-lg w-full overflow-hidden shadow-2xl border border-gray-700 animate-scale-in">
      <img :src="selectedMedia.coverImage?.extraLarge || selectedMedia.coverImage?.large" alt="" class="w-full h-56 object-cover">

      <div class="p-5">
        <h3 class="text-xl font-bold" x-text="selectedMedia.title?.english || selectedMedia.title?.romaji"></h3>
        <p class="text-sm text-gray-400 mt-1" x-text="selectedMedia.format + ' • ' + (selectedMedia.episodes || '?') + ' episodes'"></p>

        <!-- Score Badges -->
        <div class="flex space-x-2 mt-3">
          <span class="px-2 py-1 bg-anilist-pink/20 text-anilist-pink rounded text-xs font-medium" x-text="'AniList: ' + formatScore(selectedMedia.averageScore)"></span>
          <span class="px-2 py-1 bg-mal-orange/20 text-mal-orange rounded text-xs font-medium" x-text="'MAL: ' + formatScore(selectedMedia.malScore)"></span>
          <span class="px-2 py-1 bg-kitsu-purple/20 text-kitsu-purple rounded text-xs font-medium" x-text="'Kitsu: ' + formatScore(selectedMedia.kitsuScore)"></span>
        </div>

        <!-- Description -->
        <p class="mt-4 text-sm text-gray-300" x-html="selectedMedia.description?.replace(/<br>/g, ' ').replace(/<[^>]*>?/gm, '').slice(0, 200) + '...'" x-show="selectedMedia.description"></p>
        <p class="mt-4 text-sm text-gray-500" x-show="!selectedMedia.description">No description available.</p>

        <!-- Status Selector -->
        <div class="mt-5">
          <label class="block text-sm font-medium mb-2">Add to List</label>
          <select x-model="tempStatus" class="w-full bg-gray-800 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-anilist-pink">
            <option value="Planning">Planning</option>
            <option value="Watching">Watching</option>
            <option value="Completed">Completed</option>
            <option value="On Hold">On Hold</option>
            <option value="Dropped">Dropped</option>
            <option value="Rewatching">Rewatching</option>
          </select>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3 mt-5">
          <button @click="addToCurrentList" class="flex-1 bg-anilist-pink hover:bg-pink-600 py-2 rounded-lg font-medium transition">
            Add to List
          </button>
          <button @click="showModal = false" class="px-4 py-2 border border-gray-600 rounded-lg hover:bg-gray-800 transition">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Custom List Modal -->
  <div x-show="showCreateListModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0,0,0,0.8);">
    <div x-show="showCreateListModal" x-transition class="bg-gray-900 rounded-xl p-6 max-w-sm w-full animate-scale-in">
      <h3 class="text-lg font-bold mb-4">Create New List</h3>
      <input type="text" x-model="newListName" placeholder="List name" class="w-full bg-gray-800 rounded px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-anilist-pink">
      <div class="flex space-x-3">
        <button @click="createCustomList" class="flex-1 bg-anilist-pink py-2 rounded-lg font-medium">Create</button>
        <button @click="showCreateListModal = false" class="px-4 py-2 border border-gray-600 rounded-lg">Cancel</button>
      </div>
    </div>
  </div>


  <!-- Alpine.js App Logic -->
  <script>
    // --- CONFIGURE THIS --- //
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyTEn0FgzrmbtWC6Jb65r9WXBbSStbMBQzPY-StBcvXWCujVHOkq503qKUBDTAkWjaP/exec'; // 🔁 REPLACE WITH YOUR DEPLOYED URL
    // ---------------------- //

    const constants = {
      ANI_LIST_API: 'https://graphql.anilist.co',
      MAL_API: 'https://api.jikan.moe/v4',
      KITSU_API: 'https://kitsu.io/api/edge'
    };

    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        darkMode: true,
        searchQuery: '',
        searchOpen: false,
        results: [],
        loading: false,

        customLists: [
          { id: 'planning', name: 'Planning', items: [] },
          { id: 'watching', name: 'Watching', items: [] },
          { id: 'completed', name: 'Completed', items: [] },
          { id: 'onhold', name: 'On Hold', items: [] },
          { id: 'dropped', name: 'Dropped', items: [] }
        ],
        activeList: 'planning',
        showModal: false,
        showCreateListModal: false,
        newListName: '',
        selectedMedia: {},
        tempStatus: 'Planning',

        get displayedItems() {
          const list = this.customLists.find(l => l.id === this.activeList);
          return list ? list.items : [];
        },

        toggleSearch() {
          this.searchOpen = !this.searchOpen;
          if (this.searchOpen) {
            this.$nextTick(() => {
              const input = document.querySelector('input[placeholder*="Search"]');
              if (input) input.focus();
            });
          }
        },

        async fetchSearchResults() {
          if (this.searchQuery.trim().length < 2) {
            this.results = [];
            return;
          }

          this.loading = true;
          const query = `
            query ($search: String) {
              Page(page: 1, perPage: 20) {
                media(search: $search, type: ANIME, sort: RELEVANCE_DESC) {
                  id
                  title {
                    romaji
                    english
                    native
                  }
                  format
                  status
                  episodes
                  description
                  averageScore
                  coverImage {
                    extraLarge
                    large
                  }
                  siteUrl
                }
              }
            }
          `;

          try {
            const response = await fetch(constants.ANI_LIST_API, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                query,
                variables: { search: this.searchQuery }
              })
            });

            if (!response.ok) throw new Error(`AniList API Error: ${response.status}`);
            const data = await response.json();

            if (data.errors) {
              console.error("GraphQL Errors:", data.errors);
              this.results = [];
              return;
            }

            this.results = data.data.Page.media;
          } catch (err) {
            console.error("🔍 Search failed:", err.message);
            alert("Search failed. Check console. Is internet working?");
            this.results = [];
          } finally {
            this.loading = false;
          }
        },

        async fetchExternalScores(media) {
          this.selectedMedia.malScore = null;
          this.selectedMedia.kitsuScore = null;

          try {
            const malRes = await fetch(`${constants.MAL_API}/anime?q=${encodeURIComponent(media.title.romaji)}&limit=1`);
            if (malRes.ok) {
              const malData = await malRes.json();
              this.selectedMedia.malScore = malData.data?.[0]?.score || null;
            }

            const kitsuRes = await fetch(
              `${constants.KITSU_API}/anime?filter[text]=${encodeURIComponent(media.title.romaji)}&page[limit]=1`,
              { headers: { 'Accept': 'application/vnd.api+json' } }
            );
            if (kitsuRes.ok) {
              const kitsuData = await kitsuRes.json();
              const rating = kitsuData.data?.[0]?.attributes?.averageRating;
              this.selectedMedia.kitsuScore = rating ? parseFloat(rating).toFixed(1) : null;
            }
          } catch (err) {
            console.warn("External API fetch failed (rate limit?)", err);
          }
        },

        openMediaModal(media) {
          this.selectedMedia = { ...media };
          this.fetchExternalScores(media);
          this.showModal = true;
        },

        addToCurrentList() {
          const entry = {
            MediaId: this.selectedMedia.id,
            Title: this.selectedMedia.title.english || this.selectedMedia.title.romaji,
            Format: this.selectedMedia.format,
            Status: this.tempStatus,
            Score: this.selectedMedia.averageScore || 0,
            Description: (this.selectedMedia.description || '').replace(/<[^>]*>/g, '').slice(0, 200),
            DateAdded: new Date().toLocaleDateString(),
            CoverImage: this.selectedMedia.coverImage?.extraLarge || this.selectedMedia.coverImage?.large,
            SourceUrl: this.selectedMedia.siteUrl
          };

          const list = this.customLists.find(l => l.id === this.activeList);
          if (list) {
            list.items.unshift(entry);
            this.saveToSheet(entry);
            this.showModal = false;
            alert(`✅ Added to ${list.name}`);
          }
        },

        async saveToSheet(entry) {
          const payload = {
            userId: Alpine.store('user').name || 'default-user',
            ...entry
          };

          try {
            const res = await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              body: JSON.stringify(payload)
            });

            const result = await res.json();
            if (result.error) console.error("Sheet Error:", result.error);
          } catch (err) {
            console.error("❌ Failed to save to Google Sheets:", err);
            alert("Failed to sync. Check your Google Script URL.");
          }
        },

        openCreateListModal() {
          this.newListName = '';
          this.showCreateListModal = true;
        },

        createCustomList() {
          const name = this.newListName.trim();
          if (!name) return;
          const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          this.customLists.push({ id, name, items: [] });
          this.activeList = id;
          this.showCreateListModal = false;
        },

        formatScore(score) {
          return score ? parseFloat(score).toFixed(1) : 'N/A';
        }
      }));

      const username = localStorage.getItem('username') || prompt('Enter your username:', 'user') || 'user';
      localStorage.setItem('username', username);
      Alpine.store('user', { name: username });
    });

    async function loadFromSheet() {
      try {
        const userId = Alpine.store('user')?.name || 'default-user';
        const res = await fetch(`${GOOGLE_SCRIPT_URL}?method=get&userId=${encodeURIComponent(userId)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        data.result?.forEach(entry => {
          const list = Alpine.store('app').customLists.find(l => l.id === entry.Status.toLowerCase().replace(/\s+/g, ''));
          if (list) list.items.push(entry);
        });
      } catch (err) {
        console.warn("⚠️ Load failed:", err.message);
        alert("⚠️ Could not load data. Check Google Script URL and redeploy as 'Anyone'.");
      }
    }

    document.addEventListener('alpine:initialized', () => {
      loadFromSheet();
    });
  </script>

  <!-- Inline Service Worker -->
  <script>
    const swScript = `
      const CACHE = 'anitracker-v3';
      self.addEventListener('install', e => {
        self.skipWaiting();
        e.waitUntil(caches.open(CACHE));
      });
      self.addEventListener('activate', e => {
        e.waitUntil(self.clients.claim());
      });
      self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
      });
    `;
    const blob = new Blob([swScript], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(swUrl).then(() => {
        console.log('✅ Service Worker Registered');
      }).catch(err => {
        console.log('❌ SW Error:', err);
      });
    }
  </script>

</body>
</html>
